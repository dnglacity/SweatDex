v1.12 02.28.2026 Add COPPA age-gate checkbox to sign-up form
- Added: _ageConfirmed bool state to LoginScreen, reset on mode toggle
- Added: "I confirm I am 13 or older" checkbox row displayed in sign-up mode only
- Changed: _handleSubmit() now blocks sign-up and shows a snackbar if the age checkbox is unchecked

v1.12 02.28.2026 Sanitize jersey number input to prevent XSS and DB bloat
- Changed: add_player_screen.dart jersey number field now uses FilteringTextInputFormatter.allow(RegExp(r'[A-Za-z0-9]')) to block non-alphanumeric characters (e.g., <, >, ", ', ;) at the keyboard level
- Changed: jersey number max length reduced from 10 to 4 characters (covers 0–999 plus one letter suffix such as 12A)
- Added: _sanitizeJersey() helper strips non-alphanumeric chars and clamps to 4 chars at save time as defense-in-depth against programmatic API calls that bypass UI formatters

v1.12 02.28.2026 Fix email enumeration vulnerability in changeEmail
- Fixed: auth_service.dart changeEmail() no longer leaks whether an email is already registered via Postgres duplicate-key/unique-constraint error messages
- Changed: all failure paths in the RPC catch block return the same generic message ("Email change failed. Please try again later.") regardless of cause
- Changed: removed raw $e/$msg from user-facing exception strings to prevent Postgres error text from surfacing in the UI
- Changed: debugPrint calls no longer include email addresses or raw Postgres error strings

v1.12 02.28.2026 Disable OfflineCacheService on web target
- Changed: offline_cache_service.dart — all public methods (init, writeList, readList, lastUpdated, invalidate, clearAll, evictExpired) now return early (no-op / null) when kIsWeb is true
- Reason: web browsers provide no secure on-device keystore; persisting PII in browser storage is inappropriate; web always fetches fresh data from Supabase
- No caller changes required; kIsWeb is a compile-time constant so the dead code is tree-shaken on non-web builds

v1.12 02.28.2026 Replace shared_preferences with flutter_secure_storage for PII
- Changed: offline_cache_service.dart now uses flutter_secure_storage (iOS Keychain / Android EncryptedSharedPreferences) instead of shared_preferences so cached player and game-roster data (PII) is encrypted at rest
- Changed: pubspec.yaml replaces shared_preferences ^2.3.2 with flutter_secure_storage ^9.2.2
- Removed: _ensureInitialised() / SharedPreferences instance management; replaced by stateless FlutterSecureStorage instance
- Changed: clearAll() and evictExpired() now iterate via readAll() (returns Map<String,String>) instead of getKeys()

v1.12 02.28.2026 Remove athlete ID
- Removed: athlete_id field from Player model, AppUser model, AuthService (signUp, updateProfile, getCurrentUserProfile), PlayerService (_kUserColumns, _kPlayerColumns), add_player_screen.dart (controller, UI field, pre-fill, save logic), login_screen.dart (controller, UI field, sign-up call), roster_screen.dart (subtitle and detail dialog display)
- Changed: Supabase_script.md updated with ALTER TABLE migration to drop athlete_id from public.players and public.users
- Changed: security_compliance.md updated to remove athlete_id reference

v1.12 02.28.2026 Remove grade level
- Removed: grade and grade_updated_at columns from Player model, player_service.dart (_kPlayerColumns), add_player_screen.dart (grade dropdown UI + _selectedGrade state), roster_screen.dart (grade display in subtitle and detail dialog)
- Changed: supabase_schema.json updated to remove grade columns from players table
- Changed: Supabase_script.md updated with ALTER TABLE migration to drop grade and grade_updated_at columns
- Changed: security_compliance.md updated to remove grade-level references from COPPA and FERPA sections

v1.12 02.28.2026 Atomic sole-owner guard for remove_member_from_team
- Added: remove_member_from_team(p_team_id uuid, p_user_id uuid) SECURITY DEFINER RPC — performs caller auth check, sole-owner count (FOR SHARE row lock), player un-link, and membership DELETE inside a single transaction to prevent TOCTOU race where two concurrent removals could both pass the owner count and leave the team ownerless
- Changed: PlayerService.removeMemberFromTeam() now delegates entirely to the remove_member_from_team RPC; all client-side owner count queries removed
- Fixed: security_compliance.md TOCTOU finding for removeMemberFromTeam marked resolved

v1.12 02.28.2026 Scrub deleted player data from historical game rosters
- Added: scrub_deleted_player_from_rosters(p_player_id uuid) Postgres helper — removes all entries matching the deleted player from starters and substitutes JSONB arrays across every game_rosters row
- Added: delete_player(p_player_id uuid) SECURITY DEFINER RPC — authorises caller (owner/coach/team_manager), scrubs rosters, then deletes the player row
- Changed: delete_account() RPC now scrubs all players linked to the account from historical game rosters before removing auth/profile rows
- Changed: PlayerService.deletePlayer() now calls the delete_player RPC instead of a direct table DELETE
- Changed: PlayerService.bulkDeletePlayers() now delegates to deletePlayer() per-ID so every deletion goes through the scrub path

v1.12 02.28.2026 Cache wipe on all sign-out paths
- Fixed: account_settings_screen._signOut() now calls _playerService.clearCache() before signOut() — previously skipped
- Fixed: reset_password_screen._submit() now calls _playerService.clearCache() before auth.signOut() — previously skipped, also bypassed AuthService entirely
- Result: in-memory and disk caches are wiped on every sign-out path, preventing stale data leaking between accounts on a shared device

v1.12 02.28.2026 Auto-populate players on invite code redemption
- Fixed: added DROP FUNCTION IF EXISTS before CREATE OR REPLACE in supabase_script.md to resolve "cannot change return type of existing function" error on redeploy

v1.12 02.28.2026 Auto-populate players on invite code redemption
- Changed: redeem_team_invite RPC now inserts a players row pre-filled with first_name, last_name, and athlete_email from public.users, with user_id already linked, when a user redeems an invite code
- Changed: team_members row is inserted with player_id already set, so the link is established immediately
- Result: coaches only need to fill in jersey number, grade, position, etc. — no manual player creation or linking required

v1.12 02.28.2026 2205 Supabase schema consolidation
- Added: supabase_script.md — single SQL script that exports blueprint, functions, policies, triggers, foreign keys, indexes, views, and RLS status into one JSON (supabase_schema.json)
- Added: supabase_schema.json — consolidated Supabase snapshot replacing the three separate files
- Removed: supabase_blueprint.json, supabase_functions.json, supabase_policies.json

v1.12 02.28.2026 2150 Team invite system bug fix
- Fixed: redeem_team_invite RPC threw "column reference team_id is ambiguous" error; resolved by renaming RETURNS TABLE OUT parameters to out_team_id/out_team_name/out_role and correcting t.name to t.team_name
- Fixed: redeemTeamInvite() in player_service.dart updated to read out_team_id and out_team_name keys returned by the revised RPC

v1.12 02.28.2026 Team invite system
- Added: Team invite code feature — coaches and owners can generate a 6-character alphanumeric code from the Roster screen overflow menu ("Invite to Team")
- Added: Invite dialog displays the code in a styled box with expiry countdown, a Copy Code button, and an End Invite button to revoke early
- Added: Invite codes expire automatically after 24 hours; only one active code per team at a time
- Added: Supabase table team_invites with RLS (managers only) and a partial unique index enforcing one active invite per team
- Added: get_or_create_team_invite(p_team_id) RPC — returns existing active code or creates a new one
- Added: revoke_team_invite(p_team_id) RPC — deactivates the current invite code
- Added: redeem_team_invite(p_code) RPC — validates code, checks for duplicate membership, inserts team_members row with role=player, returns team_id and team_name
- Added: PlayerService.getOrCreateTeamInvite(), revokeTeamInvite(), redeemTeamInvite()
- Added: "Add Team" FAB on Team Selection screen now expands into two options: "Enter Code" (above) and "Create a Team" (same position); tapping the body collapses the menu
- Added: Enter Code dialog — 6-char input with inline validation, loading state, readable error messages for invalid/expired codes and duplicate membership; refreshes team list on success
- Changed: FAB label changed from "New Team" → "Add Team"

v1.12 02.28.2026 2123 Jersey number uniqueness warning
- Added: Jersey number uniqueness warning in add_player_screen — when typing a jersey number already assigned to another player on the team, a non-blocking orange warning appears below the field
- Added: PlayerService.getJerseyNumbers(teamId) — lightweight DB query returning all non-null jersey numbers for a team as an uppercase Set<String>
- Changed: In edit mode, the player's own current jersey is excluded from the taken set so editing it back to the same value does not trigger a false warning

v1.12 02.28.2026 Quality of life improvements
- Added: Pencil (edit) icon on each roster player row between the attendance icon and the menu icon — opens AddPlayerScreen in edit mode directly without going through the popup menu
- Added: Duplicate option in the game roster inline menu (saved_roster_screen) — prompts for a new name pre-filled as "<original> (Copy)", validates uniqueness (case-insensitive) against existing rosters, copies starters/substitutes/starter_slots to a new row
- Added: PlayerService.duplicateGameRoster() — fetches source roster and inserts a new row with copied lineup data
- Changed: Set starter slots icon in game_roster_screen AppBar changed from tune to settings (gear)
- Changed: Gear icon now opens a popup menu with "Starter Slots" and "Change Date" options instead of directly opening the slot dialog
- Added: Change Date option in game roster settings menu — opens a dialog to set or clear the game date, persisted to the DB immediately via PlayerService.updateGameRosterMeta()
- Added: PlayerService.updateGameRosterMeta() — updates game_date on an existing roster row
- Added: lib/widgets/date_input_field.dart — reusable DateInputField widget with separate YYYY / MM / DD text boxes, auto-focus advancement, and a calendar icon that opens showDatePicker
- Changed: Game date input in New Game Roster dialog (saved_roster_screen) replaced with DateInputField
- Changed: Game date input in Change Date dialog (game_roster_screen) replaced with DateInputField with a dedicated Clear button

v1.12 02.28.2026 2044 Account settings improvements
- Added: "Sign Out" button in Account Settings screen
- Added: App version footer ("Apex On Deck v2.28.26") at the bottom of Account Settings
- Added: "Change Password" button in Account Settings screen
- Added: Password change dialog prompts for current password (verified via re-auth), new password, and confirmation — blocks update if new passwords do not match
- Added: AuthService.changePassword() re-authenticates then calls Supabase Auth updateUser() to set the new password
- Added: kAppVersion constant in main.dart

v1.12 02.28.2026 Game roster size saving and validation
- Fixed: Changing the roster size (starter slots) is now persisted when saving a game roster — `updateGameRosterLineup` includes `starter_slots` in the DB update
- Fixed: Loading a saved game roster now restores the saved starter slot count so the UI reflects the correct roster size
- Added: Saving a game roster is blocked if the number of starters exceeds the roster size — a dialog prompts the coach to bench/remove a starter or increase the roster size

v1.12 02.28.2026 Performance fixes
- Fixed: Stale in-memory team cache in PlayerService — added 5-minute TTL (_teamsCacheValid) to prevent stale data on long sessions or shared devices
- Fixed: Abandoned in-flight futures in ManageMembersScreen — replaced FutureBuilder + reassigned Future with state-driven pattern (_members, _isLoading, _loadError) and a generation counter to discard superseded results
- Fixed: Hardcoded 800ms retry delay for user ID resolution — replaced direct table query + fixed retry with SECURITY DEFINER RPC (get_current_user_id), eliminating the trigger-race concern entirely and removing the retry loop
- Fixed: Legacy name-split fallback in Player.fromMap() removed — migration is complete, _kPlayerColumns never selects the legacy name column so the code was unreachable dead code
- Fixed: Missing bounds validation in getPlayersPaginated() — added assert guards for from >= 0 and to >= from
- Fixed: Triple-allocation list chain in _mapPlayers() — replaced .cast().map().toList() with single-pass .map().toList() to eliminate intermediate CastList allocation

v1.12 02.28.2026 1840
- Added: Athlete Email field in edit mode on AddPlayerScreen (re-attempts account linking on save)
- Changed: CLAUDE.md build commands split into distinct Publish, Reset, and Debug workflows
- Changed: Commands.txt updated to clarify ship vs reset workflows
